<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin — Traffic Dashboard</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
  <style>
    :root{
      --bg0:#ffffff;
      --bg1:#f4f7ff;
      --card: rgba(255,255,255,0.72);
      --stroke: rgba(11,27,58,0.10);
      --text: #0B1B3A;
      --muted: rgba(11,27,58,0.70);
      --muted2: rgba(11,27,58,0.56);
      --brand: #38BDF8;
      --brand2:#A78BFA;
      --shadow: 0 30px 80px rgba(2,6,23,0.12);
      --r: 18px;
      --max: 1120px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 20% 10%, rgba(56,189,248,0.32), transparent 60%),
        radial-gradient(1000px 650px at 85% 20%, rgba(167,139,250,0.26), transparent 60%),
        radial-gradient(900px 600px at 60% 85%, rgba(255,182,193,0.18), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    a{color:inherit; text-decoration:none}

    .nav{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(12px);
      background: rgba(255,255,255,0.58);
      border-bottom: 1px solid var(--stroke);
    }
    .nav-inner{
      max-width: var(--max);
      margin:0 auto;
      padding: 14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:34px; height:34px; border-radius: 12px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, rgba(56,189,248,0.95), rgba(167,139,250,0.88));
      color: #06203A;
      font-weight: 1000;
      box-shadow: 0 12px 24px rgba(2,6,23,0.12);
    }
    .brand b{letter-spacing:0.2px}

    .nav-actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .pill{
      padding:10px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,0.62);
      color: var(--text);
      font-weight: 900;
      cursor:pointer;
    }
    .pill.primary{
      border: 1px solid rgba(11,27,58,0.10);
      background: linear-gradient(135deg, rgba(56,189,248,0.95), rgba(167,139,250,0.88));
      color:#06203A;
    }

    main{max-width: var(--max); margin:0 auto; padding: 22px 18px 60px;}
    .note{color:var(--muted2); font-size:12px; line-height:1.5}

    .grid{display:grid; gap:12px;}
    .grid.cards{grid-template-columns: repeat(2, minmax(0,1fr));}
    .grid.panels{grid-template-columns: 1.05fr 0.95fr;}
    @media (max-width: 980px){
      .grid.cards{grid-template-columns:1fr;}
      .grid.panels{grid-template-columns:1fr;}
    }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .kpi{display:flex; align-items:flex-end; justify-content:space-between; gap:12px;}
    .kpi .label{font-weight:900; font-size:12px; color:var(--muted2)}
    .kpi .value{font-weight:1000; font-size:34px; letter-spacing:-0.02em}
    .kpi .sub{font-size:12px; color:var(--muted2)}

    h2{margin:0; font-size:16px; letter-spacing:-0.01em}
    .section-h{display:flex; justify-content:space-between; align-items:baseline; gap:10px; margin-bottom:10px}

    table{width:100%; border-collapse:collapse;}
    th,td{border-bottom:1px solid rgba(11,27,58,0.08); padding:10px 6px; font-size:13px;}
    th{color:var(--muted2); text-align:left; font-weight:900; font-size:12px;}
    td.num{text-align:right; font-variant-numeric: tabular-nums;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;}

    .hidden{display:none !important;}

    .login{
      display:flex; align-items:center; justify-content:center;
      min-height: 54vh;
    }
    .login .card{max-width: 560px; width:100%;}

    canvas{max-width:100%;}
  </style>
</head>
<body>
  <header class="nav">
    <div class="nav-inner">
      <div class="brand">
        <div class="logo">pb</div>
        <div>
          <b>Admin</b>
          <div class="note" id="hud">KST · reset 00:00</div>
        </div>
      </div>
      <div class="nav-actions">
        <a class="pill" href="/" target="_blank" rel="noreferrer">Home</a>
        <a class="pill" href="/prebim/" target="_blank" rel="noreferrer">PreBIM</a>
        <a class="pill" href="/blog/" target="_blank" rel="noreferrer">Blog</a>
        <button class="pill" id="btnRefresh" type="button">Refresh</button>
        <button class="pill" id="btnLogout" type="button">Logout</button>
      </div>
    </div>
  </header>

  <main>
    <section id="login" class="login hidden">
      <div class="card">
        <h2 style="margin-top:0">관리자 로그인</h2>
        <div class="note" style="margin-top:8px">Google 계정으로 로그인합니다. 시간 표기는 모두 <b>KST</b> 기준이며 일간 통계는 <b>자정(00:00 KST)</b>에 초기화됩니다.</div>
        <div style="margin-top:14px" id="gLogin"></div>
        <div class="note" id="loginMsg" style="margin-top:10px"></div>
      </div>
    </section>

    <section id="dash" class="hidden">
      <div class="grid cards">
        <div class="card">
          <div class="kpi">
            <div>
              <div class="label">오늘 방문자수 (PV)</div>
              <div class="note">KST 기준 오늘(00:00~)</div>
            </div>
            <div>
              <div class="value" id="pvToday">-</div>
              <div class="sub mono" id="dateToday">-</div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="kpi">
            <div>
              <div class="label">오늘 Unique IP</div>
              <div class="note">KST 기준 오늘(00:00~)</div>
            </div>
            <div>
              <div class="value" id="uvToday">-</div>
              <div class="sub">명</div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid panels" style="margin-top:12px">
        <div class="card">
          <div class="section-h">
            <h2>가장 많이 방문된 페이지 (Today Rank)</h2>
            <div class="note" id="topPagesMeta">-</div>
          </div>
          <div style="overflow:auto">
            <table>
              <thead>
                <tr><th style="width:56px">#</th><th>Path</th><th class="num" style="width:90px">PV</th><th class="num" style="width:110px">Unique IP</th></tr>
              </thead>
              <tbody id="topPagesBody"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="section-h">
            <h2>7일 Unique IP 추이</h2>
            <div class="note">KST · 일간 00:00 초기화</div>
          </div>
          <canvas id="uv7Chart" height="170"></canvas>
        </div>

        <div class="card">
          <div class="section-h">
            <h2>접속 국가</h2>
            <div class="note">Today (KST)</div>
          </div>
          <canvas id="countryPie" height="200"></canvas>
          <div class="note" style="margin-top:10px">※ Cloudflare 헤더(CF-IPCountry)가 없는 경우 ZZ로 표시됩니다.</div>
        </div>

        <div class="card">
          <div class="section-h">
            <h2>Status</h2>
            <div class="note" id="status">idle</div>
          </div>
          <div class="note">
            - 시간/일간 기준: <b>KST</b><br/>
            - 일간 리셋: <b>00:00 KST</b><br/>
            - 데이터 소스: 서버 access_log.json (최근 로그 유지)<br/>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const KST_TZ = 'Asia/Seoul';
    const ADMIN_TOKEN_KEY = 'adminToken';

    let authToken = localStorage.getItem(ADMIN_TOKEN_KEY) || '';
    let chartUv = null;
    let chartPie = null;

    const $ = (id) => document.getElementById(id);

    function setStatus(s){ const el=$('status'); if(el) el.textContent = s; }

    function fmtKstNow(){
      try{
        return new Intl.DateTimeFormat('ko-KR', { timeZone: KST_TZ, year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' }).format(new Date());
      }catch{ return new Date().toISOString(); }
    }

    async function apiAdmin(path){
      if(!authToken) throw new Error('not logged in');
      const res = await fetch(path, { headers: { 'Authorization': `Bearer ${authToken}` } });
      const data = await res.json().catch(()=>({}));
      if(!res.ok || data.success === false) throw new Error(data.error || ('HTTP '+res.status));
      return data;
    }

    function showLogin(on){
      $('login').classList.toggle('hidden', !on);
      $('dash').classList.toggle('hidden', on);
      $('btnLogout').classList.toggle('hidden', on);
      $('btnRefresh').classList.toggle('hidden', on);
    }

    function logout(){
      authToken='';
      localStorage.removeItem(ADMIN_TOKEN_KEY);
      showLogin(true);
    }

    async function verify(){
      if(!authToken){ showLogin(true); return false; }
      try{
        const v = await apiAdmin('/api/admin/verify');
        if(!v.success){ throw new Error('unauthorized'); }
        showLogin(false);
        return true;
      }catch(e){
        logout();
        return false;
      }
    }

    function initGoogle(){
      if(!window.google || !google.accounts || !google.accounts.id) return;
      google.accounts.id.initialize({
        client_id: (window.GOOGLE_CLIENT_ID || '896155827665-vc7vj9t2vmb6a1uv3jmnqbp60lf4lcm7.apps.googleusercontent.com'),
        callback: async (resp) => {
          try{
            $('loginMsg').textContent = '로그인 중…';
            const res = await fetch('/api/admin/login', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ credential: resp.credential })
            });
            const data = await res.json();
            if(!res.ok || data.success === false) throw new Error(data.error || ('HTTP '+res.status));
            authToken = data.token;
            localStorage.setItem(ADMIN_TOKEN_KEY, authToken);
            $('loginMsg').textContent = '로그인 완료';
            await verify();
            await refreshAll();
          }catch(e){
            $('loginMsg').textContent = '로그인 실패: ' + e.message;
          }
        }
      });
      google.accounts.id.renderButton(document.getElementById('gLogin'), { theme:'outline', size:'large', width: 260 });
    }

    function renderTopPages(rows){
      const tb = $('topPagesBody');
      if(!tb) return;
      if(!rows || !rows.length){ tb.innerHTML = '<tr><td colspan="4" class="note">데이터 없음</td></tr>'; return; }
      tb.innerHTML = rows.slice(0,10).map((r,idx)=>{
        const p = (r.path||'').toString();
        const hits = Number(r.hits||0)||0;
        const uv = Number(r.uv||0)||0;
        return `<tr>
          <td class="mono">${idx+1}</td>
          <td><a href="${p}" target="_blank" rel="noreferrer" style="color:rgba(11,27,58,0.9); text-decoration:underline">${p}</a></td>
          <td class="num mono">${hits.toLocaleString()}</td>
          <td class="num mono">${uv.toLocaleString()}</td>
        </tr>`;
      }).join('');
    }

    function renderUv7(daily){
      const labels = (daily||[]).map(x => String(x.day||'').slice(5));
      const uv = (daily||[]).map(x => Number(x.uv||0)||0);
      const ctx = $('uv7Chart');
      if(!ctx || !window.Chart) return;
      if(chartUv) chartUv.destroy();
      chartUv = new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[{ label:'Unique IP', data:uv, tension:0.35, borderColor:'#2563eb', backgroundColor:'rgba(37,99,235,0.12)', fill:true, pointRadius:3 }] },
        options:{
          responsive:true,
          plugins:{ legend:{ display:false } },
          scales:{ y:{ beginAtZero:true, grid:{ color:'rgba(11,27,58,0.08)' } }, x:{ grid:{ display:false } } }
        }
      });
    }

    function renderCountries(items){
      const labels = (items||[]).map(x => String(x.country||'ZZ'));
      const hits = (items||[]).map(x => Number(x.uv||x.hits||0)||0);
      const ctx = $('countryPie');
      if(!ctx || !window.Chart) return;
      if(chartPie) chartPie.destroy();
      const colors = ['#38BDF8','#A78BFA','#60A5FA','#F472B6','#34D399','#FBBF24','#FB7185','#22C55E','#0EA5E9','#6366F1','#F97316','#94A3B8'];
      chartPie = new Chart(ctx, {
        type:'pie',
        data:{ labels, datasets:[{ data:hits, backgroundColor: labels.map((_,i)=>colors[i%colors.length]) }] },
        options:{ plugins:{ legend:{ position:'bottom' } } }
      });
    }

    async function refreshAll(){
      setStatus('loading…');
      $('hud').textContent = `KST · reset 00:00 · now ${fmtKstNow()}`;
      const t = await apiAdmin('/api/admin/traffic');
      $('pvToday').textContent = (Number(t.todayHits||0)||0).toLocaleString();
      $('uvToday').textContent = (Number(t.uniqueIps||0)||0).toLocaleString();
      $('dateToday').textContent = String(t.today||'');

      const pg = await apiAdmin('/api/admin/page-traffic');
      renderTopPages(pg.topPages||[]);
      $('topPagesMeta').textContent = `${String(pg.today||'')} · Top 10`;

      const tr = await apiAdmin('/api/admin/trends');
      renderUv7(tr.daily||[]);

      const cc = await apiAdmin('/api/admin/country-traffic');
      renderCountries(cc.topCountries||[]);

      setStatus('ok');
    }

    $('btnLogout').addEventListener('click', logout);
    $('btnRefresh').addEventListener('click', async ()=>{ try{ await refreshAll(); }catch(e){ alert(e.message); } });

    (async ()=>{
      // wait for GSI
      const boot = async () => {
        await verify();
        initGoogle();
        if(authToken){ try{ await refreshAll(); }catch(e){ console.warn(e); } }
      };
      // poll until google/chart loaded enough
      const start = Date.now();
      const tick = () => {
        const ok = !!window.google;
        if(ok || (Date.now()-start)>6000) boot();
        else setTimeout(tick, 150);
      };
      tick();
    })();
  </script>
</body>
</html>
